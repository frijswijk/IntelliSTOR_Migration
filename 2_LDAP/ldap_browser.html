<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LDAP Browser - IntelliSTOR Migration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header .subtitle {
            font-size: 0.9rem;
            color: #bdc3c7;
            margin-top: 0.25rem;
        }

        .connection-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-top: 0.5rem;
        }

        .connection-status.connected {
            background-color: #27ae60;
            color: white;
        }

        .connection-status.disconnected {
            background-color: #e74c3c;
            color: white;
        }

        .connection-status.checking {
            background-color: #f39c12;
            color: white;
        }

        .container {
            display: flex;
            height: calc(100vh - 100px);
            margin: 1rem;
            gap: 1rem;
        }

        .sidebar {
            width: 300px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .search-box {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .search-box input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .search-box input:focus {
            outline: none;
            border-color: #3498db;
        }

        .search-box select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .search-box button {
            width: 100%;
            padding: 0.5rem;
            margin-top: 0.5rem;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: 500;
        }

        .search-box button:hover {
            background-color: #2980b9;
        }

        .tree-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .tree-item {
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .tree-item:hover {
            background-color: #ecf0f1;
        }

        .tree-item.selected {
            background-color: #3498db;
            color: white;
        }

        .main-content {
            flex: 1;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow-y: auto;
            padding: 1.5rem;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 0.5rem;
        }

        .entry-details {
            margin-top: 1rem;
        }

        .entry-dn {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background-color: #ecf0f1;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            word-break: break-all;
        }

        .attribute-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .attribute-table th {
            background-color: #34495e;
            color: white;
            padding: 0.75rem;
            text-align: left;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .attribute-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9rem;
        }

        .attribute-table tr:hover {
            background-color: #f8f9fa;
        }

        .attribute-name {
            font-weight: 600;
            color: #2c3e50;
            width: 200px;
        }

        .attribute-value {
            font-family: 'Courier New', monospace;
            color: #555;
            word-break: break-word;
        }

        .search-results {
            margin-top: 1rem;
        }

        .result-item {
            padding: 1rem;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .result-item:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.2);
        }

        .result-item-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.25rem;
        }

        .result-item-dn {
            font-size: 0.85rem;
            color: #7f8c8d;
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #7f8c8d;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
        }

        .error {
            padding: 1rem;
            background-color: #fadbd8;
            border: 1px solid #e74c3c;
            border-radius: 4px;
            color: #c0392b;
            margin-bottom: 1rem;
        }

        .info {
            padding: 1rem;
            background-color: #d6eaf8;
            border: 1px solid #3498db;
            border-radius: 4px;
            color: #2874a6;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>LDAP Browser</h1>
        <div class="subtitle">IntelliSTOR Migration Tool</div>
        <div id="connectionStatus" class="connection-status checking">Checking connection...</div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="search-box">
                <input type="text" id="searchQuery" placeholder="Search users and groups...">
                <select id="searchType">
                    <option value="all">All</option>
                    <option value="user">Users</option>
                    <option value="group">Groups</option>
                </select>
                <button onclick="performSearch()">Search</button>
            </div>
            <div class="tree-container" id="treeContainer">
                <div class="loading">Loading tree...</div>
            </div>
        </div>

        <div class="main-content" id="mainContent">
            <div class="empty-state">
                <div class="empty-state-icon">üîç</div>
                <h3>Welcome to LDAP Browser</h3>
                <p>Search for users and groups or browse the directory tree</p>
            </div>
        </div>
    </div>

    <script>
        // Configuration: Update this if the Flask API is running on a different host/port
        const API_BASE = 'http://127.0.0.1:5000/api';
        let currentEntry = null;

        // Check connection status
        async function checkConnection() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();

                const statusEl = document.getElementById('connectionStatus');
                if (data.connected) {
                    statusEl.textContent = 'Connected';
                    statusEl.className = 'connection-status connected';
                } else {
                    statusEl.textContent = 'Disconnected: ' + data.message;
                    statusEl.className = 'connection-status disconnected';
                }
            } catch (error) {
                const statusEl = document.getElementById('connectionStatus');
                statusEl.textContent = 'Connection Failed';
                statusEl.className = 'connection-status disconnected';
                console.error('Connection check failed:', error);
            }
        }

        // Load tree structure
        async function loadTree() {
            try {
                const response = await fetch(`${API_BASE}/tree`);
                const tree = await response.json();

                const container = document.getElementById('treeContainer');
                container.innerHTML = '';

                if (tree.length === 0) {
                    container.innerHTML = '<div class="empty-state">No organizational units found</div>';
                    return;
                }

                tree.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'tree-item';
                    div.textContent = item.name;
                    div.onclick = () => selectTreeItem(item);
                    container.appendChild(div);
                });
            } catch (error) {
                const container = document.getElementById('treeContainer');
                container.innerHTML = '<div class="error">Failed to load tree</div>';
                console.error('Tree load failed:', error);
            }
        }

        // Select tree item
        function selectTreeItem(item) {
            document.querySelectorAll('.tree-item').forEach(el => {
                el.classList.remove('selected');
            });
            event.target.classList.add('selected');

            displayEntry({ dn: item.dn });
        }

        // Perform search
        async function performSearch() {
            const query = document.getElementById('searchQuery').value;
            const type = document.getElementById('searchType').value;

            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = '<div class="loading">Searching...</div>';

            try {
                const response = await fetch(`${API_BASE}/search?q=${encodeURIComponent(query)}&type=${type}`);
                const results = await response.json();

                if (results.error) {
                    mainContent.innerHTML = `<div class="error">Error: ${results.error}</div>`;
                    return;
                }

                if (results.length === 0) {
                    mainContent.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üîç</div>
                            <h3>No Results Found</h3>
                            <p>Try a different search term</p>
                        </div>
                    `;
                    return;
                }

                let html = `
                    <div class="section-title">Search Results (${results.length})</div>
                    <div class="search-results">
                `;

                results.forEach(result => {
                    const cn = result.attributes.cn ? (Array.isArray(result.attributes.cn) ? result.attributes.cn[0] : result.attributes.cn) : 'Unknown';
                    html += `
                        <div class="result-item" onclick='displayEntry(${JSON.stringify(result)})'>
                            <div class="result-item-title">${cn}</div>
                            <div class="result-item-dn">${result.dn}</div>
                        </div>
                    `;
                });

                html += '</div>';
                mainContent.innerHTML = html;

            } catch (error) {
                mainContent.innerHTML = `<div class="error">Search failed: ${error.message}</div>`;
                console.error('Search failed:', error);
            }
        }

        // Display entry details
        function displayEntry(entry) {
            currentEntry = entry;

            let html = `
                <div class="section-title">Entry Details</div>
                <div class="entry-details">
                    <div class="entry-dn">${entry.dn}</div>
            `;

            if (entry.attributes) {
                html += `
                    <table class="attribute-table">
                        <thead>
                            <tr>
                                <th>Attribute</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                for (const [key, value] of Object.entries(entry.attributes)) {
                    const displayValue = Array.isArray(value) ? value.join(', ') : value;
                    html += `
                        <tr>
                            <td class="attribute-name">${key}</td>
                            <td class="attribute-value">${displayValue}</td>
                        </tr>
                    `;
                }

                html += `
                        </tbody>
                    </table>
                `;
            }

            html += '</div>';

            document.getElementById('mainContent').innerHTML = html;
        }

        // Enter key for search
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('searchQuery').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            // Initial load
            checkConnection();
            loadTree();

            // Refresh connection status every 30 seconds
            setInterval(checkConnection, 30000);
        });
    </script>
</body>
</html>
